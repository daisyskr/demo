<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
  <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script src="static/libs/turf.min.js"></script>
  <link rel="stylesheet" href="static/libs/Cesium/Widgets/widgets.css" />
  <script src="static/libs/Cesium/Cesium.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/kdbush"></script>
  <title>cesium加载大数据量</title>
</head>

<body>
  <div id="app">
    <el-button @click="clickEvent(1)">entity测试</el-button>
    <el-button @click="clickEvent(2)">primitive测试</el-button>
    <el-button @click="clickEvent(3)">entity聚合测试</el-button>
    <el-button @click="clickEvent(4)">primitive聚合测试</el-button>
  </div>
  <div id="mapContainer"></div>
</body>
<script type="module">
  import EntityCluster from './EntityCluster.js'
  import PrimitiveCluster from './PrimitiveCluster.js'
  Cesium.Ion.defaultAccessToken =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4NTFhNzNiMC1hNDg2LTQ2ZjktOWU4OC02ZWYyNmRlNWZmOWYiLCJpZCI6NDcwNjMsImlhdCI6MTYxNjg0NzA1M30.4dNi5U6RimD-MY3abc2dXdGS-xpTatDMqMeUS5cnfAA'
  let viewer = new Cesium.Viewer('mapContainer')
  // 显示帧率
  viewer.scene.debugShowFramesPerSecond = true
  // let tdtLayer = new Cesium.UrlTemplateImageryProvider({
  //   url: 'https://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png',
  //   subdomains: ['a', 'b', 'c', 'd'],
  // })
  // viewer.imageryLayers.addImageryProvider(tdtLayer)
  // viewer.scene.fxaa = false
  // viewer.scene.postProcessStages.fxaa.enabled = false
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(115.07093905148879, 33.893744274680095, 2124853)
  })

  const getPoints = (callback = () => { }) => {
    let bbox = [110.35502558000002, 31.384368830000028, 116.64641233000009, 36.36650799000006]
    let number = 100000
    // let points = turf.randomPoint(200000, { bbox })
    // let features = points.features
    // return features
    //初始化worker
    let worker = new Worker('static/worker.js')
    //主函数向worker发送数据
    worker.postMessage([number, JSON.parse(JSON.stringify(bbox))])
    //主函数监听获取woker计算后的数据
    worker.addEventListener('message', function handleMessageFromWorker(msg) {
      worker.terminate() //关闭worker
      let points = msg.data
      callback(points?.features)
    })
  }
  const addEntity = () => {
    viewer.entities.removeAll()
    let features = getPoints()
    features.forEach((item, index) => {
      viewer.entities.add({
        // name: "e",
        position: Cesium.Cartesian3.fromDegrees(...item.geometry.coordinates),
        // point: {
        //   pixelSize: 5,
        //   color: Cesium.Color.RED,
        //   outlineColor: Cesium.Color.WHITE,
        //   outlineWidth: 2,
        // },
        billboard: {
          image: "static/images/red_position.png",
          width: 64,
          height: 64,
        },
        label: {
          text: index.toString(),
          font: "14pt monospace",
          style: Cesium.LabelStyle.FILL,
          outlineWidth: 2,
          verticalOrigin: Cesium.VerticalOrigin.TOP,
          pixelOffset: new Cesium.Cartesian2(-3, 30),
          // disableDepthTestDistance: Number.POSITIVE_INFINITY,
        },
      })
    })
    // viewer.zoomTo(viewer.entities)
  }
  let billboardsPrimitives, labelsPrimitives = null
  const addPrimitive = (options) => {
    !billboardsPrimitives && (billboardsPrimitives = viewer.scene.primitives.add(new Cesium.BillboardCollection()))
    !labelsPrimitives && (labelsPrimitives = viewer.scene.primitives.add(new Cesium.LabelCollection()))
    billboardsPrimitives.removeAll()
    labelsPrimitives.removeAll()
    // let points = getPoints()
    getPoints((features) => {
      console.log('拿到点位', features.length)
      console.time('绘制')
      features.forEach((item, index) => {
        billboards.add({
          position: new Cesium.Cartesian3.fromDegrees(...item.geometry.coordinates),
          image: "static/images/red_position.png"
        })
        // labelboards.add({
        //   position: new Cesium.Cartesian3.fromDegrees(...item.geometry.coordinates),
        //   text: index.toString(),
        //   font: "14pt monospace",
        //   style: Cesium.LabelStyle.FILL,
        //   outlineWidth: 2,
        //   verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        //   pixelOffset: new Cesium.Cartesian2(0, 10),
        //   // disableDepthTestDistance: Number.POSITIVE_INFINITY,
        // })
      })
      console.timeEnd('绘制')
    })
  }
  let entityCluster = null
  const addEntityCluster = () => {
    !entityCluster && (entityCluster = new EntityCluster(viewer))
    getPoints((features) => {
      entityCluster.draw({ data: features })
    })
  }
  // primitive 实现点位聚合（有图标，没有名称）
  const addPrimitiveCluster1 = () => {
    getPoints((features) => {
      // 使用primitives 添加点
      let labels = new Cesium.LabelCollection()
      let billboards = new Cesium.BillboardCollection()
      let collection = new Cesium.PrimitiveCollection()

      features.forEach(item => {
        let center = {
          lng: item.geometry.coordinates[0],
          lat: item.geometry.coordinates[1],
        }
        let title = {
          id: item.id || '11',
          position: Cesium.Cartesian3.fromDegrees(Number(center.lng), Number(center.lat), 0),
          text: item.name || 'xxx',
          font: "30px Source Han Sans CN", //字体样式
          fillColor: new Cesium.Color.fromCssColorString("#ffffff"), //字体颜色
          showBackground: true, //是否显示背景颜色
          backgroundColor: new Cesium.Color.fromCssColorString("#000000"), //背景颜色
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM, //垂直位置
          horizontalOrigin: Cesium.HorizontalOrigin.CENTER, //水平位置
        }
        let img = {
          id: item.id || '11',
          position: Cesium.Cartesian3.fromDegrees(Number(center.lng), Number(center.lat), 80),
          image: item.url || "static/images/red_position.png",
          width: item.poiWid || 40,
          height: item.poiHig || 40,
          scale: 1,
          verticalOrigin: Cesium.VerticalOrigin.TOP, //垂直位置
        }
        labels.add(title)
        billboards.add(img)
      })
      let primitivecluster = null
      primitivecluster = new PrimitiveCluster()
      primitivecluster.enabled = true
      primitivecluster.pixelRange = 1
      primitivecluster.minimumClusterSize = 10
      primitivecluster._billboardCollection = billboards
      // 同时在赋值时调用_initialize方法
      primitivecluster._initialize(viewer.scene)
      collection.add(primitivecluster)
      // this.primitivesCluster = viewer.scene.primitives.add(collection)
      viewer.scene.primitives.add(collection)
      const pinBuilder = new Cesium.PinBuilder()
      primitivecluster.clusterEvent.addEventListener((clusteredEntities, cluster) => {
        // 关闭自带的显示聚合数量的标签
        cluster.label.show = false
        cluster.billboard.show = true
        cluster.billboard.verticalOrigin = Cesium.VerticalOrigin.BOTTOM
        let pinImg = pinBuilder.fromText(cluster.label.text, Cesium.Color.RED, 60).toDataURL()
        // 根据聚合数量的多少设置不同层级的图片以及大小
        cluster.billboard.image = pinImg
      })
    })


    // {
    //   lng
    //   lat
    //   id
    //   name
    //   url
    //   poiWid
    //   poiHig
    // }
    // let a = {
    //   "geometry": {
    //     "coordinates": [125.37309576840005, 43.82650035842283],
    //     "type": "Point"
    //   },
    //   "properties": {
    //     "height": "15.1",
    //     "name": "吴函",
    //     "age": 6,
    //     "sex": "女",
    //     "image": "static/image/cluster/girl.png"
    //   }
    // }

    // return primitivecluster
  }
  let defaultOption = {
    data: [],
    pixelRange: 60,
    minimumClusterSize: 2,
    originImageSize: 64,
    poiStyle: {
      image: './static/images/colored_user.png',
      width: 32,
      height: 32,
      showlabel: true,
      label: 'name',
      labelStyle: {
        font: 'bold 15px Microsoft YaHei',
        verticalOrigin: 'CENTER',
        horizontalOrigin: 'LEFT',
        pixelOffset: [15, 0],
        style: 'FILL',
        showBackground: true,
        backgroundColor: '#50b2b7',
      },
    },
    interval: [
      {
        interval: [2, 10],
        image: './static/images/light_blue_bkg.png',
        width: 40,
        height: 40,
      },
      {
        interval: [11, 50],
        image: './static/images/dark_blue_bkg.png',
        width: 48,
        height: 48,
      },
      {
        interval: [51, 100],
        image: './static/images/orange_bkg.png',
        width: 56,
        height: 56,
      },
      {
        interval: [101, 9999999999],
        image: './static/images/red_bkg.png',
        width: 72,
        height: 72,
      },
    ],
  }
  const addPrimitiveCluster = () => {
    getPoints((features) => {
      const primitives = viewer.scene.primitives.add(
        new Cesium.PrimitiveCollection()
      )
      const billboardCollection = new Cesium.BillboardCollection()
      const labelCollection = new Cesium.LabelCollection()
      const primitiveCluster = new PrimitiveCluster()
      primitives.add(primitiveCluster)
      
      primitiveCluster.enabled = true //开启聚合功能
      let { pixelRange, minimumClusterSize, originImageSize, interval } = defaultOption
      let { image, width, height, showlabel, label, labelStyle } = defaultOption.poiStyle
      let { font, verticalOrigin, horizontalOrigin, pixelOffset, style, showBackground, backgroundColor } = labelStyle
      primitiveCluster.pixelRange = pixelRange
      primitiveCluster.minimumClusterSize = minimumClusterSize
      primitiveCluster._billboardCollection = billboardCollection
      primitiveCluster._labelCollection = labelCollection
      primitiveCluster._initialize(viewer.scene)

      features.forEach((item) => {
        let { geometry, properties = {} } = item
        let center = geometry.type == 'Point' ? { geometry } : turf.centroid({ type: 'Feature', geometry })
        let z = Number(properties?.height) || 0
        primitiveCluster._billboardCollection.add({
          position: Cesium.Cartesian3.fromDegrees(...center.geometry.coordinates, z),
          image: properties?.image || image,
          width,
          height,
        })
        // primitiveCluster._labelCollection.add({
        //   position: Cesium.Cartesian3.fromDegrees(...center.geometry.coordinates, z),
        //   text: '11'
        // })
      })

      primitiveCluster.clusterEvent.addEventListener(function(
        clusteredEntities,
        cluster
      ) {
        // 关闭自带的显示聚合数量的标签
        cluster.label.show = false
        cluster.billboard.show = true
        cluster.billboard.verticalOrigin = Cesium.VerticalOrigin.BOTTOM

        // 根据聚合数量的多少设置不同层级的图片以及大小
        interval.forEach((item) => {
          if (clusteredEntities.length >= item.interval[0] && clusteredEntities.length < item.interval[1]) {
            cluster.billboard.image = combineIconAndLabel(
              item.image,
              clusteredEntities.length,
              originImageSize || 64
            )
            cluster.billboard.width = item.width || 48
            cluster.billboard.height = item.height || 48
          }
        })
        cluster.billboard.disableDepthTestDistance = Number.POSITIVE_INFINITY //防止billboard被建筑遮盖
      })
    })




  }
  const combineIconAndLabel = (url, label, size) => {
    // 创建画布对象
    let canvas = document.createElement('canvas')
    canvas.width = size
    canvas.height = size
    let ctx = canvas.getContext('2d')
    let resource = Cesium.Resource
    let promise = new resource.fetchImage(url).then((image) => {
      // 异常判断
      try {
        ctx.drawImage(image, 0, 0)
      } catch (e) {
        console.log(e)
      }
      // 渲染字体
      // font属性设置顺序：font-style, font-variant, font-weight, font-size, line-height, font-family
      ctx.fillStyle = Cesium.Color.WHITE.toCssColorString()
      ctx.font = 'bold 20px Microsoft YaHei'
      ctx.textAlign = 'center'
      ctx.textBaseline = 'middle'
      ctx.fillText(label, size / 2, size / 2)

      return canvas
    })
    return promise
  }




  let vue = new Vue({
    el: '#app',
    data: function() {
      return {
        loading: false,
        resultPoints: null,
      }
    },
    methods: {
      clickEvent(val) {
        switch (val) {
          case 1:
            addEntity()
            break
          case 2:
            addPrimitive()
            break
          case 3:
            addEntityCluster()
            break
          case 4:
            addPrimitiveCluster()
            break
          default:
            break
        }
      }
    },
  })
</script>
<style scoped>
  body {
    overflow: hidden;
  }

  #app {
    width: 100%;
    display: flex;
    padding: 15px;
  }

  #mapContainer {
    width: 100%;
    height: 800px;
  }
</style>

</html>
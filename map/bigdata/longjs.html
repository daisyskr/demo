<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" />
  <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script src="static/libs/turf.min.js"></script>
  <link rel="stylesheet" href="static/libs/Cesium/Widgets/widgets.css" />
  <script src="static/libs/Cesium/Cesium.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/kdbush"></script>
  <script src="./PrimitiveCluster.js"></script>
  <title>cesium加载大数据量</title>
</head>

<body>
  <div id="app">
    <el-button @click="clickEvent(1)">entity测试</el-button>
    <el-button @click="clickEvent(2)">primitive测试</el-button>
    <el-button @click="clickEvent(3)">primitive聚合测试</el-button>
  </div>
  <div id="mapContainer"></div>
</body>
<script>
  Cesium.Ion.defaultAccessToken =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4NTFhNzNiMC1hNDg2LTQ2ZjktOWU4OC02ZWYyNmRlNWZmOWYiLCJpZCI6NDcwNjMsImlhdCI6MTYxNjg0NzA1M30.4dNi5U6RimD-MY3abc2dXdGS-xpTatDMqMeUS5cnfAA'
  let viewer = new Cesium.Viewer('mapContainer')
  // 显示帧率
  viewer.scene.debugShowFramesPerSecond = true
  // let tdtLayer = new Cesium.UrlTemplateImageryProvider({
  //   url: 'https://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png',
  //   subdomains: ['a', 'b', 'c', 'd'],
  // })
  // viewer.imageryLayers.addImageryProvider(tdtLayer)
  // viewer.scene.fxaa = false
  // viewer.scene.postProcessStages.fxaa.enabled = false
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(115.07093905148879, 33.893744274680095, 2124853)
  })

  const getPoints = (callback = () => { }) => {
    let bbox = [110.35502558000002, 31.384368830000028, 116.64641233000009, 36.36650799000006]
    let number = 1000
    // let points = turf.randomPoint(200000, { bbox })
    // let features = points.features
    // return features
    //初始化worker
    let worker = new Worker('static/worker.js')
    //主函数向worker发送数据
    worker.postMessage([number, JSON.parse(JSON.stringify(bbox))])
    //主函数监听获取woker计算后的数据
    worker.addEventListener('message', function handleMessageFromWorker(msg) {
      worker.terminate() //关闭worker
      let points = msg.data
      callback(points?.features)
    })
  }
  const addEntity = () => {
    viewer.entities.removeAll()
    let features = getPoints()
    features.forEach((item, index) => {
      viewer.entities.add({
        // name: "e",
        position: Cesium.Cartesian3.fromDegrees(...item.geometry.coordinates),
        // point: {
        //   pixelSize: 5,
        //   color: Cesium.Color.RED,
        //   outlineColor: Cesium.Color.WHITE,
        //   outlineWidth: 2,
        // },
        billboard: {
          image: "static/image/point.png",
          width: 64,
          height: 64,
        },
        label: {
          text: index.toString(),
          font: "14pt monospace",
          style: Cesium.LabelStyle.FILL,
          outlineWidth: 2,
          verticalOrigin: Cesium.VerticalOrigin.TOP,
          pixelOffset: new Cesium.Cartesian2(-3, 30),
          // disableDepthTestDistance: Number.POSITIVE_INFINITY,
        },
      })
    })
    // viewer.zoomTo(viewer.entities)
  }
  let billboardsPrimitives, labelsPrimitives = null
  const addPrimitive = (options) => {
    !billboardsPrimitives && (billboardsPrimitives = viewer.scene.primitives.add(new Cesium.BillboardCollection()))
    !labelsPrimitives && (labelsPrimitives = viewer.scene.primitives.add(new Cesium.LabelCollection()))
    billboardsPrimitives.removeAll()
    labelsPrimitives.removeAll()
    // let points = getPoints()
    getPoints((features) => {
      console.log('拿到点位', features.length)
      console.time('绘制')
      features.forEach((item, index) => {
        billboards.add({
          position: new Cesium.Cartesian3.fromDegrees(...item.geometry.coordinates),
          image: "static/image/point.png"
        })
        // labelboards.add({
        //   position: new Cesium.Cartesian3.fromDegrees(...item.geometry.coordinates),
        //   text: index.toString(),
        //   font: "14pt monospace",
        //   style: Cesium.LabelStyle.FILL,
        //   outlineWidth: 2,
        //   verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        //   pixelOffset: new Cesium.Cartesian2(0, 10),
        //   // disableDepthTestDistance: Number.POSITIVE_INFINITY,
        // })
      })
      console.timeEnd('绘制')
    })
  }

  // primitive 实现点位聚合（有图标，没有名称）
  const addPrimitiveCluster = () => {
    getPoints((features) => {
      // 使用primitives 添加点
      let labels = new Cesium.LabelCollection()
      let billboards = new Cesium.BillboardCollection()
      let collection = new Cesium.PrimitiveCollection()

      features.forEach(item => {
        let center = {
          lng: item.geometry.coordinates[0],
          lat: item.geometry.coordinates[1],
        }
        let title = {
          id: item.id || '11',
          position: Cesium.Cartesian3.fromDegrees(Number(center.lng), Number(center.lat), 0),
          text: item.name || 'xxx',
          font: "30px Source Han Sans CN", //字体样式
          fillColor: new Cesium.Color.fromCssColorString("#ffffff"), //字体颜色
          showBackground: true, //是否显示背景颜色
          backgroundColor: new Cesium.Color.fromCssColorString("#000000"), //背景颜色
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM, //垂直位置
          horizontalOrigin: Cesium.HorizontalOrigin.CENTER, //水平位置
        }
        let img = {
          id: item.id || '11',
          position: Cesium.Cartesian3.fromDegrees(Number(center.lng), Number(center.lat), 80),
          image: item.url || "static/image/point.png",
          width: item.poiWid || 40,
          height: item.poiHig || 40,
          scale: 1,
          verticalOrigin: Cesium.VerticalOrigin.TOP, //垂直位置
        }
        labels.add(title)
        billboards.add(img)
      })
      let primitivecluster = null
      primitivecluster = new PrimitiveCluster()
      primitivecluster.enabled = true
      primitivecluster.pixelRange = 1
      primitivecluster.minimumClusterSize = 10
      primitivecluster._billboardCollection = billboards
      // 同时在赋值时调用_initialize方法
      primitivecluster._initialize(viewer.scene)
      collection.add(primitivecluster)
      this.primitivesCluster = viewer.scene.primitives.add(collection)
      const pinBuilder = new Cesium.PinBuilder()
      primitivecluster.clusterEvent.addEventListener((clusteredEntities, cluster) => {
        // 关闭自带的显示聚合数量的标签
        cluster.label.show = false
        cluster.billboard.show = true
        cluster.billboard.verticalOrigin = Cesium.VerticalOrigin.BOTTOM
        let pinImg = pinBuilder.fromText(cluster.label.text, Cesium.Color.RED, 60).toDataURL()
        // 根据聚合数量的多少设置不同层级的图片以及大小
        cluster.billboard.image = pinImg
      })
    })


    // {
    //   lng
    //   lat
    //   id
    //   name
    //   url
    //   poiWid
    //   poiHig
    // }
    // let a = {
    //   "geometry": {
    //     "coordinates": [125.37309576840005, 43.82650035842283],
    //     "type": "Point"
    //   },
    //   "properties": {
    //     "height": "15.1",
    //     "name": "吴函",
    //     "age": 6,
    //     "sex": "女",
    //     "image": "static/image/cluster/girl.png"
    //   }
    // }

    // return primitivecluster
  }




  let vue = new Vue({
    el: '#app',
    data: function() {
      return {
        loading: false,
        resultPoints: null,
      }
    },
    methods: {
      clickEvent(val) {
        switch (val) {
          case 1:
            addEntity()
            break
          case 2:
            addPrimitive()
            break
          case 3:
            addPrimitiveCluster()
            break
          default:
            break
        }
      }
    },
  })
</script>
<style scoped>
  body {
    overflow: hidden;
  }

  #app {
    width: 100%;
    display: flex;
    padding: 15px;
  }

  #mapContainer {
    width: 100%;
    height: 800px;
  }
</style>

</html>